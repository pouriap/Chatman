/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package com.pouria.chatman.gui;

import com.github.kevinsawicki.HttpRequest;
import com.google.common.base.Charsets;
import com.google.common.io.BaseEncoding;
import com.google.common.io.Files;
import com.pouria.chatman.Chatman;
import com.pouria.chatman.ChatmanClient;
import com.pouria.chatman.ChatmanServer;
import com.pouria.chatman.classes.HistoryTablePagination;
import com.pouria.chatman.classes.ResourceBundleWrapper;
import java.awt.Color;
import java.awt.Cursor;
import java.awt.Desktop;
import java.awt.Image;
import java.awt.Toolkit;
import java.awt.datatransfer.DataFlavor;
import java.awt.dnd.DnDConstants;
import java.awt.dnd.DropTarget;
import java.awt.dnd.DropTargetDropEvent;
import java.awt.event.ActionEvent;
import java.awt.event.MouseEvent;
import java.io.File;
import java.io.IOException;
import java.net.URISyntaxException;
import java.net.URL;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.SQLException;
import java.util.Date;
import java.util.List;
import java.util.Locale;
import javax.swing.AbstractAction;
import javax.swing.Action;
import javax.swing.DefaultListModel;
import javax.swing.JOptionPane;
import javax.swing.event.HyperlinkEvent;
import javax.swing.table.AbstractTableModel;
import javax.swing.table.DefaultTableModel;
import javax.swing.text.DefaultEditorKit;
import javax.swing.text.html.HTMLEditorKit;

/**
 *
 * @author PouriaP
 * 
 * This file has the main() function and is the entry point of the application
 * 
 */
public class ChatFrame extends javax.swing.JFrame {

    private static ChatFrame instance = null; 
    private Chatman chatman;
    private String[] defaultTextAreaHtml;
    private String incomingTextAll = "";
    private String textAreaIncomingContentBeforeHistory = "";
    private HistoryTablePagination historyPagination;
	
	private boolean peerWindowIsHidden = true;
    
    public ResourceBundleWrapper l;

    
    private ChatFrame(){
        initComponents();
    }
    
    
    public static ChatFrame getInstance(){
        if(instance == null)
            instance = new ChatFrame();
        
        return instance;
    }
    

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        dialogPopup = new com.pouria.chatman.gui.PopupDialog();
        panelPopup = new javax.swing.JPanel();
        labelNewMessage = new javax.swing.JLabel();
        labelMessageIcon = new javax.swing.JLabel();
        menuRightClick = new javax.swing.JPopupMenu();
        dialogHistory = new javax.swing.JDialog();
        scrollPaneHistory = new javax.swing.JScrollPane();
        tableHistory = new javax.swing.JTable();
        buttonNextHistoryPage = new javax.swing.JButton();
        buttonPrevHistoryPage = new javax.swing.JButton();
        labelServers = new javax.swing.JLabel();
        scrollPaneLiveServers = new javax.swing.JScrollPane();
        listLiveServers = new javax.swing.JList<>();
        scrollPaneIncoming = new javax.swing.JScrollPane();
        textAreaIncoming = new javax.swing.JEditorPane();
        scrollPaneOutgoing = new javax.swing.JScrollPane();
        textAreaOutgoing = new javax.swing.JEditorPane();
        incomingBg = new javax.swing.JLabel();
        outgoingBg = new javax.swing.JLabel();
        tableEmojis = new javax.swing.JTable();
        labelSend = new javax.swing.JLabel();
        labelClear = new javax.swing.JLabel();
        labelStatusLabl = new javax.swing.JLabel();
        labelStatus = new javax.swing.JLabel();
        backgroundOfLabels = new javax.swing.JLabel();
        labelFrameBg = new javax.swing.JLabel();
        jMenuBar1 = new javax.swing.JMenuBar();
        menuFile = new javax.swing.JMenu();
        menuChangeBg = new javax.swing.JMenuItem();
        menuShowHistory = new javax.swing.JMenuItem();
        menuResetModem = new javax.swing.JMenuItem();
        menuShutdownPC = new javax.swing.JMenuItem();
        menuWakeOnLan = new javax.swing.JMenuItem();
        menuAbout = new javax.swing.JMenuItem();
        menuExit = new javax.swing.JMenuItem();

        dialogPopup.setAlwaysOnTop(true);
        dialogPopup.setMinimumSize(new java.awt.Dimension(180, 60));
        dialogPopup.setResizable(false);

        panelPopup.setBackground(new java.awt.Color(102, 102, 102));
        panelPopup.setBorder(javax.swing.BorderFactory.createEtchedBorder());
        panelPopup.setCursor(new java.awt.Cursor(java.awt.Cursor.HAND_CURSOR));
        panelPopup.setName(""); // NOI18N
        panelPopup.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseReleased(java.awt.event.MouseEvent evt) {
                panelPopupMouseReleased(evt);
            }
        });

        labelNewMessage.setFont(new java.awt.Font("Tahoma", 0, 24)); // NOI18N
        labelNewMessage.setForeground(new java.awt.Color(231, 231, 231));
        labelNewMessage.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        labelNewMessage.setText("پیام جدید");

        labelMessageIcon.setIcon(new javax.swing.ImageIcon(getClass().getResource("/resources/new_message_50x50.png"))); // NOI18N

        javax.swing.GroupLayout panelPopupLayout = new javax.swing.GroupLayout(panelPopup);
        panelPopup.setLayout(panelPopupLayout);
        panelPopupLayout.setHorizontalGroup(
            panelPopupLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, panelPopupLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(labelMessageIcon, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(labelNewMessage)
                .addGap(16, 16, 16))
        );
        panelPopupLayout.setVerticalGroup(
            panelPopupLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(labelMessageIcon, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
            .addGroup(panelPopupLayout.createSequentialGroup()
                .addComponent(labelNewMessage, javax.swing.GroupLayout.PREFERRED_SIZE, 52, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(0, 0, Short.MAX_VALUE))
        );

        javax.swing.GroupLayout dialogPopupLayout = new javax.swing.GroupLayout(dialogPopup.getContentPane());
        dialogPopup.getContentPane().setLayout(dialogPopupLayout);
        dialogPopupLayout.setHorizontalGroup(
            dialogPopupLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(panelPopup, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
        );
        dialogPopupLayout.setVerticalGroup(
            dialogPopupLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(panelPopup, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
        );

        menuRightClick.setBackground(new java.awt.Color(51, 51, 51));
        menuRightClick.setForeground(new java.awt.Color(255, 255, 255));

        dialogHistory.setTitle("تاریخچه");
        dialogHistory.setAlwaysOnTop(true);
        dialogHistory.setIconImage(null);
        dialogHistory.setMinimumSize(new java.awt.Dimension(400, 300));
        dialogHistory.addWindowListener(new java.awt.event.WindowAdapter() {
            public void windowClosed(java.awt.event.WindowEvent evt) {
                dialogHistoryWindowClosed(evt);
            }
            public void windowClosing(java.awt.event.WindowEvent evt) {
                dialogHistoryWindowClosing(evt);
            }
            public void windowOpened(java.awt.event.WindowEvent evt) {
                dialogHistoryWindowOpened(evt);
            }
        });

        tableHistory.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        tableHistory.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "تاریخ", "متن"
            }
        ) {
            Class[] types = new Class [] {
                java.lang.String.class, java.lang.String.class
            };
            boolean[] canEdit = new boolean [] {
                false, false
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        tableHistory.setCursor(new java.awt.Cursor(java.awt.Cursor.HAND_CURSOR));
        tableHistory.setRowHeight(20);
        tableHistory.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseReleased(java.awt.event.MouseEvent evt) {
                tableHistoryMouseReleased(evt);
            }
        });
        scrollPaneHistory.setViewportView(tableHistory);

        buttonNextHistoryPage.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        buttonNextHistoryPage.setText("صفحه بعد");
        buttonNextHistoryPage.setEnabled(false);
        buttonNextHistoryPage.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                buttonNextHistoryPageActionPerformed(evt);
            }
        });

        buttonPrevHistoryPage.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        buttonPrevHistoryPage.setText("صفحه قبل");
        buttonPrevHistoryPage.setEnabled(false);
        buttonPrevHistoryPage.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                buttonPrevHistoryPageActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout dialogHistoryLayout = new javax.swing.GroupLayout(dialogHistory.getContentPane());
        dialogHistory.getContentPane().setLayout(dialogHistoryLayout);
        dialogHistoryLayout.setHorizontalGroup(
            dialogHistoryLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(dialogHistoryLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(dialogHistoryLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, dialogHistoryLayout.createSequentialGroup()
                        .addComponent(buttonPrevHistoryPage)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addComponent(buttonNextHistoryPage))
                    .addComponent(scrollPaneHistory, javax.swing.GroupLayout.DEFAULT_SIZE, 380, Short.MAX_VALUE))
                .addContainerGap())
        );
        dialogHistoryLayout.setVerticalGroup(
            dialogHistoryLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(dialogHistoryLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(scrollPaneHistory, javax.swing.GroupLayout.DEFAULT_SIZE, 394, Short.MAX_VALUE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(dialogHistoryLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(buttonNextHistoryPage)
                    .addComponent(buttonPrevHistoryPage))
                .addContainerGap())
        );

        setDefaultCloseOperation(javax.swing.WindowConstants.DO_NOTHING_ON_CLOSE);
        setTitle("Chatman - (This isn't a chat)");
        setFocusable(false);
        setMinimumSize(new java.awt.Dimension(500, 650));
        setResizable(false);
        addWindowListener(new java.awt.event.WindowAdapter() {
            public void windowClosing(java.awt.event.WindowEvent evt) {
                formWindowClosing(evt);
            }
            public void windowOpened(java.awt.event.WindowEvent evt) {
                formWindowOpened(evt);
            }
        });
        getContentPane().setLayout(null);

        labelServers.setBackground(new java.awt.Color(255, 255, 255));
        labelServers.setFont(new java.awt.Font("Tahoma", 1, 14)); // NOI18N
        labelServers.setForeground(new java.awt.Color(255, 255, 255));
        labelServers.setText("Select a server to connect to");
        getContentPane().add(labelServers);
        labelServers.setBounds(120, 34, 240, 30);

        listLiveServers.setFont(new java.awt.Font("Tahoma", 0, 14)); // NOI18N
        listLiveServers.setCursor(new java.awt.Cursor(java.awt.Cursor.HAND_CURSOR));
        listLiveServers.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseReleased(java.awt.event.MouseEvent evt) {
                listLiveServersMouseReleased(evt);
            }
        });
        scrollPaneLiveServers.setViewportView(listLiveServers);

        getContentPane().add(scrollPaneLiveServers);
        scrollPaneLiveServers.setBounds(120, 70, 240, 140);

        scrollPaneIncoming.setOpaque(false);

        textAreaIncoming.setEditable(false);
        textAreaIncoming.setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(153, 153, 153)));
        textAreaIncoming.setContentType("text/html"); // NOI18N
        textAreaIncoming.setAutoscrolls(false);
        textAreaIncoming.setOpaque(false);
        textAreaIncoming.addHyperlinkListener(new javax.swing.event.HyperlinkListener() {
            public void hyperlinkUpdate(javax.swing.event.HyperlinkEvent evt) {
                textAreaIncomingHyperlinkUpdate(evt);
            }
        });
        scrollPaneIncoming.setViewportView(textAreaIncoming);

        getContentPane().add(scrollPaneIncoming);
        scrollPaneIncoming.setBounds(20, 20, 460, 210);

        scrollPaneOutgoing.setBorder(null);
        scrollPaneOutgoing.setOpaque(false);

        textAreaOutgoing.setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(153, 153, 153)));
        textAreaOutgoing.setContentType("text/html"); // NOI18N
        textAreaOutgoing.setCaretColor(new java.awt.Color(255, 255, 255));
        textAreaOutgoing.setOpaque(false);
        textAreaOutgoing.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseReleased(java.awt.event.MouseEvent evt) {
                textAreaOutgoingMouseReleased(evt);
            }
        });
        textAreaOutgoing.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyReleased(java.awt.event.KeyEvent evt) {
                textAreaOutgoingKeyReleased(evt);
            }
        });
        scrollPaneOutgoing.setViewportView(textAreaOutgoing);

        getContentPane().add(scrollPaneOutgoing);
        scrollPaneOutgoing.setBounds(20, 330, 270, 150);

        incomingBg.setIcon(new javax.swing.ImageIcon(getClass().getResource("/resources/opacity77.png"))); // NOI18N
        getContentPane().add(incomingBg);
        incomingBg.setBounds(20, 20, 460, 210);

        outgoingBg.setIcon(new javax.swing.ImageIcon(getClass().getResource("/resources/opacity77.png"))); // NOI18N
        getContentPane().add(outgoingBg);
        outgoingBg.setBounds(20, 330, 270, 150);

        tableEmojis.setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(153, 153, 153)));
        tableEmojis.setForeground(new java.awt.Color(255, 255, 255));
        tableEmojis.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null, null},
                {null, null, null, null, null},
                {null, null, null, null, null},
                {null, null, null, null, null},
                {null, null, null, null, null}
            },
            new String [] {
                "Title 1", "Title 2", "Title 3", "Title 4", "Title 5"
            }
        ));
        tableEmojis.setCursor(new java.awt.Cursor(java.awt.Cursor.HAND_CURSOR));
        tableEmojis.setOpaque(false);
        tableEmojis.setRowHeight(30);
        tableEmojis.setRowSelectionAllowed(false);
        tableEmojis.setSelectionBackground(new java.awt.Color(255, 255, 255));
        tableEmojis.setShowHorizontalLines(false);
        tableEmojis.setShowVerticalLines(false);
        tableEmojis.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseReleased(java.awt.event.MouseEvent evt) {
                tableEmojisMouseReleased(evt);
            }
        });
        getContentPane().add(tableEmojis);
        tableEmojis.setBounds(300, 330, 170, 150);

        labelSend.setBackground(new java.awt.Color(51, 51, 51));
        labelSend.setFont(new java.awt.Font("Tahoma", 1, 14)); // NOI18N
        labelSend.setForeground(new java.awt.Color(255, 255, 255));
        labelSend.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        labelSend.setText("ارسال");
        labelSend.setBorder(new javax.swing.border.SoftBevelBorder(javax.swing.border.BevelBorder.RAISED));
        labelSend.setCursor(new java.awt.Cursor(java.awt.Cursor.HAND_CURSOR));
        labelSend.setOpaque(true);
        labelSend.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseReleased(java.awt.event.MouseEvent evt) {
                labelSendMouseReleased(evt);
            }
        });
        getContentPane().add(labelSend);
        labelSend.setBounds(20, 490, 130, 30);

        labelClear.setBackground(new java.awt.Color(51, 51, 51));
        labelClear.setFont(new java.awt.Font("Tahoma", 1, 14)); // NOI18N
        labelClear.setForeground(new java.awt.Color(255, 255, 255));
        labelClear.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        labelClear.setText("پاک کردن");
        labelClear.setBorder(javax.swing.BorderFactory.createBevelBorder(javax.swing.border.BevelBorder.RAISED));
        labelClear.setCursor(new java.awt.Cursor(java.awt.Cursor.HAND_CURSOR));
        labelClear.setOpaque(true);
        labelClear.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseReleased(java.awt.event.MouseEvent evt) {
                labelClearMouseReleased(evt);
            }
        });
        getContentPane().add(labelClear);
        labelClear.setBounds(160, 490, 130, 30);

        labelStatusLabl.setForeground(new java.awt.Color(255, 255, 255));
        labelStatusLabl.setText("Status:");
        getContentPane().add(labelStatusLabl);
        labelStatusLabl.setBounds(20, 560, 150, 40);

        labelStatus.setForeground(new java.awt.Color(255, 255, 255));
        labelStatus.setText("Offline");
        getContentPane().add(labelStatus);
        labelStatus.setBounds(170, 560, 300, 40);

        backgroundOfLabels.setBackground(new java.awt.Color(51, 51, 51));
        backgroundOfLabels.setOpaque(true);
        getContentPane().add(backgroundOfLabels);
        backgroundOfLabels.setBounds(0, 560, 500, 40);

        labelFrameBg.setIcon(new javax.swing.ImageIcon(getClass().getResource("/resources/bg/batman.jpg"))); // NOI18N
        getContentPane().add(labelFrameBg);
        labelFrameBg.setBounds(0, 0, 500, 600);

        menuFile.setText("گزینه ها");
        menuFile.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        menuFile.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        menuFile.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
        menuFile.setMargin(new java.awt.Insets(0, 10, 0, 0));
        menuFile.setPreferredSize(new java.awt.Dimension(70, 23));
        menuFile.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                menuFileActionPerformed(evt);
            }
        });

        menuChangeBg.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        menuChangeBg.setText("تغییر پس زمینه");
        menuChangeBg.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                menuChangeBgActionPerformed(evt);
            }
        });
        menuFile.add(menuChangeBg);

        menuShowHistory.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        menuShowHistory.setText("نمایش تاریخچه");
        menuShowHistory.setToolTipText("");
        menuShowHistory.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                menuShowHistoryActionPerformed(evt);
            }
        });
        menuFile.add(menuShowHistory);

        menuResetModem.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        menuResetModem.setText("ریست مودم");
        menuResetModem.setEnabled(false);
        menuResetModem.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                menuResetModemActionPerformed(evt);
            }
        });
        menuFile.add(menuResetModem);

        menuShutdownPC.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        menuShutdownPC.setText("خاموش کردن کامپیوتر");
        menuShutdownPC.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                menuShutdownPCActionPerformed(evt);
            }
        });
        menuFile.add(menuShutdownPC);

        menuWakeOnLan.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        menuWakeOnLan.setText("از خواب پا شه");
        menuWakeOnLan.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                menuWakeOnLanActionPerformed(evt);
            }
        });
        menuFile.add(menuWakeOnLan);

        menuAbout.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        menuAbout.setText("درباره");
        menuAbout.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                menuAboutActionPerformed(evt);
            }
        });
        menuFile.add(menuAbout);

        menuExit.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        menuExit.setText("خروج");
        menuExit.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                menuExitActionPerformed(evt);
            }
        });
        menuFile.add(menuExit);

        jMenuBar1.add(menuFile);

        setJMenuBar(jMenuBar1);

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void formWindowOpened(java.awt.event.WindowEvent evt) {//GEN-FIRST:event_formWindowOpened

    }//GEN-LAST:event_formWindowOpened

    private void formWindowClosing(java.awt.event.WindowEvent evt) {//GEN-FIRST:event_formWindowClosing

		//if peer is also hidden then exit
		if(peerWindowIsHidden){
			exit();
		}
		//else just hide window
		else{
			hideWindow();
		}
    }//GEN-LAST:event_formWindowClosing

    private void textAreaOutgoingKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_textAreaOutgoingKeyReleased

        if (evt.getKeyChar() == '\n'){ 
            send();
        }
    }//GEN-LAST:event_textAreaOutgoingKeyReleased

    private void menuFileActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_menuFileActionPerformed
        
    }//GEN-LAST:event_menuFileActionPerformed

    private void menuChangeBgActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_menuChangeBgActionPerformed
        
        Background.getInstance().next();
        setBackground(Background.getInstance().getCurrentURL());

        if(chatman != null)
            chatman.updateUserName();
       
        //doClick() so user doesn't have to open menu over and over again for changing bg
        menuFile.doClick();

    }//GEN-LAST:event_menuChangeBgActionPerformed

    private void tableEmojisMouseReleased(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_tableEmojisMouseReleased

        int row = tableEmojis.getSelectedRow();
        int col = tableEmojis.getSelectedColumn();
         
        //replace the emoticon image with the larger image. we also add the width=50 and height=50 for better display
        String img = (String) tableEmojis.getValueAt(row, col);
		if(img.contains("wide")){
			img = img.replaceAll("<html>(.*)emoticons(.*\\.gif')\\s(\\/>)<\\/html>", "$1emoticons_large$2 height=50 width=70 $3");
		}
		else{
			img = img.replaceAll("<html>(.*)emoticons(.*\\.gif')\\s(\\/>)<\\/html>", "$1emoticons_large$2 height=50 width=50 $3");
		}
        
        
        //true = append
        updateOutgoingText(img, true);
        textAreaOutgoing.requestFocus();
    
    }//GEN-LAST:event_tableEmojisMouseReleased

    private void textAreaIncomingHyperlinkUpdate(javax.swing.event.HyperlinkEvent evt) {//GEN-FIRST:event_textAreaIncomingHyperlinkUpdate
        //triggered when we click on a link
        if(evt.getEventType() == HyperlinkEvent.EventType.ACTIVATED){
            try{
                String path = evt.getURL().toString();
                
                //open if it was a file
                if(path.contains("file://")){
                    path = path.substring(7);
                    Desktop.getDesktop().open(new File(path));
                }
                //browse if it was a URL
                else
                    Desktop.getDesktop().browse(evt.getURL().toURI());
                
            }catch(IOException e){
                message(l.getString("url_open_fail") + e.getMessage());
            }catch(URISyntaxException e){
                message(l.getString("bad_url") + e.getMessage());
            }
        }
    }//GEN-LAST:event_textAreaIncomingHyperlinkUpdate

    private void menuExitActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_menuExitActionPerformed

        exit();
    }//GEN-LAST:event_menuExitActionPerformed

    private void panelPopupMouseReleased(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_panelPopupMouseReleased
        //close the "New Message" popup and show the application window
        dialogPopup.hidePopup();
        //Show
        showWindow();
        //Focus
        textAreaOutgoing.requestFocus();
    }//GEN-LAST:event_panelPopupMouseReleased

    private void labelSendMouseReleased(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_labelSendMouseReleased

        send();
    }//GEN-LAST:event_labelSendMouseReleased

    private void labelClearMouseReleased(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_labelClearMouseReleased

        defaultOutgoingText();
    }//GEN-LAST:event_labelClearMouseReleased

    private void textAreaOutgoingMouseReleased(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_textAreaOutgoingMouseReleased
        //show the right-click menu
        if(evt.getButton() == MouseEvent.BUTTON3){
            menuRightClick.show(textAreaOutgoing, evt.getX(), evt.getY());
        } 
    }//GEN-LAST:event_textAreaOutgoingMouseReleased

    //this is for resetting my modem. don't mint it.
    private void menuResetModemActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_menuResetModemActionPerformed

        int reset = JOptionPane.showConfirmDialog(null, l.getString("modem_reset_confirm"), l.getString("reset"), JOptionPane.YES_NO_OPTION);
        if(reset == JOptionPane.NO_OPTION)
            return;
        
        HttpRequest request = HttpRequest.post("http://192.168.1.1/index/login.cgi")
                .header("User-Agent", "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:38.0) Gecko/20100101 Firefox/38.0")
                .header("Accept", "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8")
                .header("Accept-Language", "en-US,en;q=0.8,fa-IR;q=0.5,fa;q=0.3")
                .header("Accept-Encoding", "gzip, deflate")
                .header("DNT", "1")
                .header("Referer", "http://192.168.1.1/")
                .header("Cookie", "FirstMenu=Admin_0; SecondMenu=Admin_0_0; ThirdMenu=Admin_0_0_0; Language=en;")
                //it's safe to add this here because menu is only shown if "modem-user-pass" is set
                .send(ChatmanConfig.getInstance().get("modem-user-pass"));

        String cookie = (request.header("Set-Cookie"));
        
        request = HttpRequest.post("http://192.168.1.1/html/management/reboot.cgi?RequestFile=/html/management/reset.asp")
                .header("User-Agent", "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:38.0) Gecko/20100101 Firefox/38.0")
                .header("Accept", "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8")
                .header("Accept-Language", "en-US,en;q=0.8,fa-IR;q=0.5,fa;q=0.3")
                .header("Accept-Encoding", "gzip, deflate")
                .header("DNT", "1")
                .header("Referer", "http://192.168.1.1/html/management/reset.asp")
                .header("Cookie", "FirstMenu=Admin_0; SecondMenu=Admin_0_0; ThirdMenu=Admin_0_0_0; Language=en; " + cookie);
        if(request.body().isEmpty()){
            message(l.getString("modem_reset_fail"));
        }
        else{
            exit();    
        }
        
    }//GEN-LAST:event_menuResetModemActionPerformed

    private void dialogHistoryWindowOpened(java.awt.event.WindowEvent evt) {//GEN-FIRST:event_dialogHistoryWindowOpened
        //is run everytime history dialog opens
        
        //store incoming text
        textAreaIncomingContentBeforeHistory = incomingTextAll;
        
        historyPagination = new HistoryTablePagination(
                tableHistory,
                "history.sqlite",
                "SELECT date,text FROM chat_sessions ORDER BY date DESC"
        );

        try{
            historyPagination.nextPage();
            buttonNextHistoryPage.setEnabled(historyPagination.hasNext());
            
        }catch(SQLException e){
            message(l.getString("history_fail") + e.getMessage());
        }

    }//GEN-LAST:event_dialogHistoryWindowOpened

    private void menuShowHistoryActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_menuShowHistoryActionPerformed
        //show history dialog
        dialogHistory.setLocationRelativeTo(null);
        dialogHistory.setVisible(true);
    }//GEN-LAST:event_menuShowHistoryActionPerformed

    private void tableHistoryMouseReleased(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_tableHistoryMouseReleased
        //put selected history item in textAreaIncoming
        int row = tableHistory.getSelectedRow();
        String text = tableHistory.getModel().getValueAt(row, 1).toString();
        //if we do updateIncomingText(text) then text will be regexed again. But it is already parsed and saved.
        incomingTextAll = text;
        updateIncomingText("<br>", false);
        
    }//GEN-LAST:event_tableHistoryMouseReleased

    private void dialogHistoryWindowClosed(java.awt.event.WindowEvent evt) {//GEN-FIRST:event_dialogHistoryWindowClosed
    }//GEN-LAST:event_dialogHistoryWindowClosed

    private void dialogHistoryWindowClosing(java.awt.event.WindowEvent evt) {//GEN-FIRST:event_dialogHistoryWindowClosing
        //restore the incoming text
        incomingTextAll = "";
        updateIncomingText(textAreaIncomingContentBeforeHistory, false);
    }//GEN-LAST:event_dialogHistoryWindowClosing

    private void buttonNextHistoryPageActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_buttonNextHistoryPageActionPerformed
        
        try{
            historyPagination.nextPage();
            buttonNextHistoryPage.setEnabled(historyPagination.hasNext());
            buttonPrevHistoryPage.setEnabled(historyPagination.hasPrev());
        }catch(SQLException e){
            message(l.getString("history_fail") + e.getMessage());
        }
    }//GEN-LAST:event_buttonNextHistoryPageActionPerformed

    private void buttonPrevHistoryPageActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_buttonPrevHistoryPageActionPerformed

        try{
            historyPagination.prevPage();
            buttonNextHistoryPage.setEnabled(historyPagination.hasNext());
            buttonPrevHistoryPage.setEnabled(historyPagination.hasPrev());
        }catch(SQLException e){
            message(l.getString("history_fail") + e.getMessage());
        }
    }//GEN-LAST:event_buttonPrevHistoryPageActionPerformed

    private void listLiveServersMouseReleased(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_listLiveServersMouseReleased
        //connect to selected server
        int index = listLiveServers.getSelectedIndex();
        ((ChatmanClient)getChatmanInstance()).setServerSocket(index);
        ((ChatmanClient)getChatmanInstance()).start();
    }//GEN-LAST:event_listLiveServersMouseReleased

    private void menuAboutActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_menuAboutActionPerformed
        // TODO add your handling code here:
        JOptionPane.showMessageDialog(null, l.getString("license"), l.getString("about"), JOptionPane.PLAIN_MESSAGE, null);
    }//GEN-LAST:event_menuAboutActionPerformed

    private void menuShutdownPCActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_menuShutdownPCActionPerformed
        // TODO add your handling code here:
		chatman.sendShutdown();
    }//GEN-LAST:event_menuShutdownPCActionPerformed

    private void menuWakeOnLanActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_menuWakeOnLanActionPerformed
        // TODO add your handling code here:
		try{
			Runtime.getRuntime().exec("wolcmd 9C5C8E719827 192.168.2.21 255.255.255.0");
			
		}catch(IOException e){
			message(l.getString("wakeonlan_fail"));
		}
    }//GEN-LAST:event_menuWakeOnLanActionPerformed

    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        /* Set the Nimbus look and feel */
        //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
        /* If Nimbus (introduced in Java SE 6) is not available, stay with the default look and feel.
         * For details see http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html 
         */
        try {
            for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
                if ("Windows".equals(info.getName())) {
                    javax.swing.UIManager.setLookAndFeel(info.getClassName());
                    break;
                }
            }
        } catch (ClassNotFoundException ex) {
            java.util.logging.Logger.getLogger(ChatFrame.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (InstantiationException ex) {
            java.util.logging.Logger.getLogger(ChatFrame.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (IllegalAccessException ex) {
            java.util.logging.Logger.getLogger(ChatFrame.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (javax.swing.UnsupportedLookAndFeelException ex) {
            java.util.logging.Logger.getLogger(ChatFrame.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        }
        //</editor-fold>

        final int mode;

        if(args.length == 1){
            mode = Chatman.MOD_SERVER;
        }
        else if(args.length == 0){ 
            mode = Chatman.MOD_CLIENT;
        }
        else{
            System.out.println("invalid arguments");
            System.exit(0);
            mode = -1;
        }
        
        /* Create and display the form */
        java.awt.EventQueue.invokeLater(new Runnable() {
            public void run() {
                ChatFrame frame = ChatFrame.getInstance();
                frame.myInits();
                frame.startChatman(mode);
            }
        });
    }
     
    
    public void myInits(){
        
        //Locale
        mSetLocale(ChatmanConfig.getInstance().getLocale());

        
        //setup GUI elements texts accordig to locale
        setupGUITexts();

        
        //don't show modem reset to strangers
        if(!ChatmanConfig.getInstance().isSet("modem-user-pass")){
            menuResetModem.setVisible(false);
        }

		
        //TextArea Dorp
        //We read the whole file as text and then base64_encode it which causes a LOT of memory
        //to be consumed. But i'm lazy, so it's ok.
        textAreaOutgoing.setDropTarget(new DropTarget() {
            public synchronized void drop(DropTargetDropEvent evt) {
                try {
                    //clear any text
                    defaultOutgoingText();
                    
                    evt.acceptDrop(DnDConstants.ACTION_COPY);
                    List<File> droppedFiles = (List<File>) evt
                            .getTransferable().getTransferData(
                                    DataFlavor.javaFileListFlavor);
                    for (File file : droppedFiles) {
                        textAreaOutgoing.setText(file.getAbsolutePath());
                        
                        //check file size
                        int max = Integer.valueOf(ChatmanConfig.getInstance().get("max-file-size"));
                        if(file.length()> max*1000*1000){
                            message(l.getString("max_file_size") + max + "MB");
                            continue;
                        }

                        //send the file
                        String name = file.getName();
                        name = BaseEncoding.base64().encode(name.getBytes(Charsets.UTF_8));
                        byte[] data = Files.toByteArray(file);
                        String base64data = BaseEncoding.base64().encode(data);
                        chatman.sendFile(name, base64data);

                        //show file sent message and clear textAreaOutgoing
                        updateIncomingText(l.getString("file_sent") + file.getName());
                        defaultOutgoingText();

                    }
                } catch (Exception ex) {
                    message(l.getString("open_file_fail"));
                }
            }
        });
        

        //TextArea right click
        
        //create a paste action because the default is problematic
        Action paste = new AbstractAction(l.getString("paste")) {
            @Override
            public void actionPerformed(ActionEvent e) {
                textAreaOutgoing.paste();
                String s = textAreaOutgoing.getText();
                //clear html tags and new lines
                s = s.replaceAll("<[\\/\\w]*>", "").replace("\n", "").trim();
                updateOutgoingText(s,true);
            }
        }; 
        
        //setup copy and cut
        Action copyAction = textAreaOutgoing.getActionMap().get(DefaultEditorKit.copyAction);
        copyAction.putValue("Name", l.getString("copy"));
        Action cutAction = textAreaOutgoing.getActionMap().get(DefaultEditorKit.cutAction);
        cutAction.putValue("Name", l.getString("cut"));
        
        menuRightClick.add (paste); 
        menuRightClick.add (copyAction);
        menuRightClick.add (cutAction);

        
        //TextArea cursor
        ((HTMLEditorKit)textAreaOutgoing.getEditorKit()).setDefaultCursor(new Cursor(Cursor.TEXT_CURSOR));
        
        
        //TextArea focus
        textAreaOutgoing.requestFocus();
        
        
        //Table BG
        tableEmojis.setBackground(new Color(50,50,50,170));  

        
        //Populate Table
        //!!!IMPORTANT: only words in emoticons name 
        //!!!IMPORTANT: emoticons should have .gif extention and be stored in /resources/emoticons folder
        //!!!IMPORTANT: any change made here, or to emoticons names,format,folder,etc. should be also applied to regular expression accross the code
        String[][] emoticonsArray = new String[][]{
            {"hi", "smoke", "xd", "amazing", "victory"},
            {"bleed", "desperate", "spiral", "shake", "shooting"},
            {"calmdownwide", "killwide", "getout", "wallbangwide", "extraordinary"},
            {"yes","grumpyno","grumpy","dog","epicface"},
            {"snail","bat","wifi","reset","question"},
        };
             
        //make tableEmoji's cells uneditable
        AbstractTableModel model = new DefaultTableModel(5, 5){
            @Override
            public boolean isCellEditable(int row, int column){
                return false;
            }
        };
        
        //add emoticons to cells
        for(int row = 0;row<5;row++){
            for(int col = 0;col<5;col++){
                String name = emoticonsArray[row][col];
                URL url = getClass().getResource("/resources/emoticons/" + name + ".gif");
                if(url != null)
                    name = url.toString();
                String h = "<html><img src='" + name + "' /></html>";
                model.setValueAt(h, row, col);
            }
        }
        tableEmojis.setModel(model);

        
        //Frame BG
        setBackground(Background.getInstance().getCurrentURL());
       
        
        //Empty HTML Texts
        defaultTextAreaHtml = new String[2];
        defaultTextAreaHtml[0] = "<html><head><style type=\"text/css\">#text { color: white; font-family: Tahoma; font-size: 12px }</style></head><body><div id=\"text\">";
        defaultTextAreaHtml[1] = "</div></body></html>";
        defaultOutgoingText();
        defaultIncomingText();        
        
        
        //Make ScrollPanes invisible
        scrollPaneOutgoing.setOpaque(false);
        scrollPaneOutgoing.getViewport().setOpaque(false);
        scrollPaneIncoming.setOpaque(false);
        scrollPaneIncoming.getViewport().setOpaque(false);
        
        
        //Make server list invisible
        labelServers.setVisible(false);
        scrollPaneLiveServers.setVisible(false);
              
        
        //Icons
        //main frame
        java.net.URL url = getClass().getResource("/resources/icon.png");
        Toolkit kit = Toolkit.getDefaultToolkit();
        Image img = kit.createImage(url);
        this.setIconImage(img);
        
        //history dialog
        url = getClass().getResource("/resources/history.png");
        img = kit.createImage(url);
        dialogHistory.setIconImage(img);
        

        //Center
        this.setLocationRelativeTo(null);

        
    } 
    
    //start Chatman as client/server
    public void startChatman(int mode){
        //server
        if(mode == Chatman.MOD_SERVER){
            chatman = new ChatmanServer();
            chatman.start();
        }
        //client
        else if(mode == Chatman.MOD_CLIENT){ 
            chatman = new ChatmanClient();
            chatman.start();
            this.setVisible(true);
        }
        else{
            message(l.getString("invalid_args"));
            exit(true);
        }
        
    }
    
    
    //Called from myInits()
    public void mSetLocale(Locale locale){
        try{
            l = new ResourceBundleWrapper("resources.locale.locale", locale);
        }catch(Exception e){
            message(e.getMessage());
            exit();
        }
    }
    
    //Called from myInits()
    public void setupGUITexts(){
        labelNewMessage.setText(l.getString("new_message"));
        dialogHistory.setTitle(l.getString("history"));
        buttonNextHistoryPage.setText(l.getString("next_page"));
        buttonPrevHistoryPage.setText(l.getString("prev_page"));
        labelSend.setText(l.getString("send"));
        labelClear.setText(l.getString("clear"));
        labelStatusLabl.setText(l.getString("status"));
        labelStatus.setText(l.getString("offline"));
        menuFile.setText(l.getString("options"));
        menuChangeBg.setText(l.getString("change_bg"));
        menuShowHistory.setText(l.getString("show_history"));
        menuResetModem.setText(l.getString("reset_modem"));
		menuShutdownPC.setText(l.getString("shutdown"));
		menuWakeOnLan.setText(l.getString("wakeonlan"));
        menuAbout.setText(l.getString("about"));
        menuExit.setText(l.getString("exit"));
    }
    
    //sends the content of textAreaOutgoing
    private void send(){
        //is run when Enter is pressed or Ersal is pressed
        if(chatman.getMode() == Chatman.MOD_CLIENT)
            if(!((ChatmanClient)chatman).isConnected()){
                message(l.getString("not_connected"));
                return;
        }
        
        String s = getOutgoingText();
        
        //return if textarea is empty
        if(s.isEmpty())
            return;

        //'\n' should only be at the end of the message because we use readline()
        s = s.replace("\n", "").trim();
        
        updateIncomingText("<b>" + l.getString("you") + ": </b>" + s);
        chatman.send("<b>" + chatman.getUserName() + ": </b>" + s);
        
        defaultOutgoingText();
    }
    
    //parses the string that is given to it and adds it to textAreaIncoming
    //it is called both when we send a message or receive a message
    public void updateIncomingText(String t, boolean bleep){
        //updates the textareaIncoming. Is run when we say something or the other guy says something
        
        //popup when first message received
        if(isHidden()){
            dialogPopup.showPopup();
            dialogPopup.playSound();
        }
        //bleep if we received message and was not focused
        else if(!this.isActive() && bleep){
            dialogPopup.playSound();
        }

        if(t.isEmpty()){
            defaultIncomingText();
            return;
        }
        
        //parse web links 
        t = t.replaceAll("((http|https)://[^\\s]*)\\s?", "<a style='color:#dee3e9;font-weight:bold;' href='$1'>$1</a> ");
        
        //parse file links
        t = t.replaceAll("(file:\\/\\/([^\\.]*\\..*))", "<a style='color:#dee3e9;font-weight:bold;' href='$1'>$2</a> ");
        
        //parse emoticons
        //(when we send emoticons, they actually get replaced by themselves, but it's ok)
        String url = getClass().getResource("/resources/emoticons_large/").toString();
		t = t.replaceAll("src=\"[^\"]*emoticons_large\\/([^\"]*\\.gif)\"", "src=\"" + url + "$1\"");
        
        incomingTextAll = incomingTextAll + t + "<br />";
        textAreaIncoming.setText(defaultTextAreaHtml[0] + incomingTextAll + defaultTextAreaHtml[1]);
        
    }
    
    //lazy version 
    public void updateIncomingText(String t){
        updateIncomingText(t, true);
    }
    
    //clears textAreaIncoming
    public void defaultIncomingText(){
        textAreaIncoming.setText(defaultTextAreaHtml[0] + defaultTextAreaHtml[1]);
    }
    
    //is called when we want to add something to the outgoing text like emoticons, paste stuff, or disconnect message
    public void updateOutgoingText(String t, boolean append){

        if(append){
            textAreaOutgoing.setText(defaultTextAreaHtml[0] + getOutgoingText() + t + defaultTextAreaHtml[1]);
        }
        else{
            textAreaOutgoing.setText(defaultTextAreaHtml[0] + t + defaultTextAreaHtml[1]);
        }
    }
    
    //because i couldn't find a way to get the text in a clean manner, i am extracting stuff between <div></div> tags
    //which i have added for this porpuse to defaultTextAreaHtml
    public String getOutgoingText(){
        String s = textAreaOutgoing.getText();
        if(!s.contains("<div id=\"text\">"))
            return "";
        return s.substring((s.indexOf("<div id=\"text\">"))+15, (s.indexOf("</div>"))-1).trim();
    }
    
    //clears textAreaOutgoing
    public void defaultOutgoingText(){
        textAreaOutgoing.setText(defaultTextAreaHtml[0] + defaultTextAreaHtml[1]);
    }
    
    //well, sets the background
    public void setBackground(URL url){
        labelFrameBg.setIcon(new javax.swing.ImageIcon(url));
    }
    
    //well,...
    public void addToServerList(String server){
        if(listLiveServers.getModel().getSize() == 0)
            listLiveServers.setModel(new DefaultListModel<String>());
        
        ((DefaultListModel) listLiveServers.getModel()).addElement("<html><b style='text-align:center'>" + server + "</b></html>");
    }
    
    //umm..., shows the server list?
    public void showServerList(){
        labelServers.setVisible(true);
        scrollPaneLiveServers.setVisible(true);
    }
    
    //let me guess... removes the serverlist!
    public void removeServerList(){
        this.remove(scrollPaneLiveServers);
        this.remove(labelServers);
        this.repaint();
        this.revalidate();
    }
    
    
    public void saveHistory(){
        //we don't want to save empty stuff
        if(incomingTextAll.isEmpty())
            return;
        
        Connection c = null;
        PreparedStatement stmt = null;
        Date date = new Date();
        
        try {
            Class.forName("org.sqlite.JDBC");
            c = DriverManager.getConnection("jdbc:sqlite:history.sqlite");
            c.setAutoCommit(false);            

            stmt = c.prepareStatement("INSERT INTO chat_sessions (date, text) Values(? , ?)");
            stmt.setString(1, String.valueOf(date.getTime()));
            stmt.setString(2, incomingTextAll);
            stmt.executeUpdate();
            c.commit();
            
            stmt.close();
            c.close();
        } catch ( Exception e ) {
            message(l.getString("history_save_fail") + e.getMessage());
        }
    }
    
    //disable textAreaOutgoing and put a message in it
    public void endSession(String message){
        updateOutgoingText("<span style='font-size:20px;'>" + message + "</span>", false);
        textAreaOutgoing.setEnabled(false);
    }
    
    //gives us the hero that we don't deserve
    public Chatman getChatmanInstance(){
        return chatman;
    }

    //sets the status label at the bottom
    public void setLabelStatus(String s){
        labelStatus.setText(s);
    }
    
    //shows a message
    public void message(String m){
        m = "<html><span style='font-size:14px;'>" + m + "</span></html>";
        JOptionPane.showMessageDialog(null, m);
    } 
    
    //the mask is for the ones you love. we stay hidden unless it's neccessary to show up
    public boolean isHidden(){
        if(!this.isVisible() && !dialogPopup.isVisible())
            return true;
        
        return false;
    }
	
	public void setPeerWindowIsHidden(boolean b){
		peerWindowIsHidden = b;
	}
	
	//hides the chatman windows
	public void hideWindow(){
		
		this.setVisible(false);
		
        //we need to check if we are connected when we're client but server is always connected
        if(chatman.getMode() == Chatman.MOD_CLIENT){
            if(((ChatmanClient)chatman).isConnected())
                chatman.sendHidden();
        }
		else{
            chatman.sendHidden();
		}

	}
	
	//shows the chatman window
	public void showWindow(){
		
		this.setVisible(true);
		
        //we need to check if we are connected when we're client but server is always connected
        if(chatman.getMode() == Chatman.MOD_CLIENT){
            if(((ChatmanClient)chatman).isConnected())
                chatman.sendVisible();
        }
		else{
            chatman.sendVisible();
		}
		
	}
	
    //the end of chatman. that's it. no auto pilot :(
    public void exit(){
		
		hideWindow();

        saveHistory();
                
        ChatmanConfig.getInstance().save();
        
        System.exit(0);
		
    }
    
    //reckless exit. used in tests
    public void exit(boolean reckless){
        if(reckless){
            System.exit(0);
        }
        else{
            exit();
        }
    }
    


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JLabel backgroundOfLabels;
    private javax.swing.JButton buttonNextHistoryPage;
    private javax.swing.JButton buttonPrevHistoryPage;
    private javax.swing.JDialog dialogHistory;
    private com.pouria.chatman.gui.PopupDialog dialogPopup;
    private javax.swing.JLabel incomingBg;
    private javax.swing.JMenuBar jMenuBar1;
    private javax.swing.JLabel labelClear;
    private javax.swing.JLabel labelFrameBg;
    private javax.swing.JLabel labelMessageIcon;
    private javax.swing.JLabel labelNewMessage;
    private javax.swing.JLabel labelSend;
    private javax.swing.JLabel labelServers;
    private javax.swing.JLabel labelStatus;
    private javax.swing.JLabel labelStatusLabl;
    private javax.swing.JList<String> listLiveServers;
    private javax.swing.JMenuItem menuAbout;
    private javax.swing.JMenuItem menuChangeBg;
    private javax.swing.JMenuItem menuExit;
    private javax.swing.JMenu menuFile;
    private javax.swing.JMenuItem menuResetModem;
    private javax.swing.JPopupMenu menuRightClick;
    private javax.swing.JMenuItem menuShowHistory;
    private javax.swing.JMenuItem menuShutdownPC;
    private javax.swing.JMenuItem menuWakeOnLan;
    private javax.swing.JLabel outgoingBg;
    private javax.swing.JPanel panelPopup;
    private javax.swing.JScrollPane scrollPaneHistory;
    private javax.swing.JScrollPane scrollPaneIncoming;
    private javax.swing.JScrollPane scrollPaneLiveServers;
    private javax.swing.JScrollPane scrollPaneOutgoing;
    private javax.swing.JTable tableEmojis;
    private javax.swing.JTable tableHistory;
    private javax.swing.JEditorPane textAreaIncoming;
    private javax.swing.JEditorPane textAreaOutgoing;
    // End of variables declaration//GEN-END:variables
}
